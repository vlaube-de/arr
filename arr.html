<html>
  <head>
    <title></title>
    <script type="text/javascript" src="underscore.js"></script>
  </head>
  <body></body>
<script>

function cond() {
  var environment = this;
  var resultClause = _.find(arguments, function(clause) {
    return arr(environment, clause[0]);
  });
  return arr(environment, resultClause[1]);
}

function eq(a, b) {
  return a === b;
}

function mod(a, b) {
  return a % b;
}

function print(str) {
  document.writeln(str+'<br />');
}

function lambda() {
  var environment = this;
  var argNames = _.initial(arguments);
  var array = _.last(arguments);

  return function() {
    // add arguments to the local environment
    var localEnvironment = _.clone(environment);
    var args = _.object(argNames, arguments);
    _.extend(localEnvironment, args);
    return arr(localEnvironment, array);
  };
}

function arr(environment, array) {
  if(typeof array == 'undefined') {
    array = environment;
    environment = {};
  }
  if(array instanceof Array) {
    if(array[0] != lambda && array[0] != defun && array[0] != cond) { // do not evaluate the body of a lambda expression (yet)
      array = _.map(array, function(value) {
        return arr(environment, value);
      });
    }
  } else if(typeof array == 'string') {
    try {
      // XXX: does this make the variables immutable?
      with(environment) {
        array = eval(array);
      }
    } catch(e) {}
  }

  var first = _.first(array);

  if(typeof first == 'string') {
    if(environment[first]) {
      first = environment[first];
    } else {
      return array;
    }
  }
  if(typeof first == 'function') {
    var rest = _.rest(array);
    return first.apply(environment, rest);
  }
  return array;
}

var each = _.each;
var map = _.map;
var range = _.range;

arr(
 [each,
    [map,
      [range, 1, 101],
      [lambda, 'number',
        [cond,
          [[eq, [mod, 'number', 15], 0], 'FizzBuzz'],
          [[eq, [mod, 'number',  3], 0], 'Fizz'],
          [[eq, [mod, 'number',  5], 0], 'Buzz'],
          [true, 'number']
        ]
      ]
    ],
    print
  ]
);

var environment = {};
var toTest = arr(environment,
  [map,
    [range, 1, 101],
    [lambda, 'number',
      [cond,
        [[eq, [mod, 'number', 15], 0], 'FizzBuzz'],
        [[eq, [mod, 'number',  3], 0], 'Fizz'],
        [[eq, [mod, 'number',  5], 0], 'Buzz'],
        [true, 'number']
      ]
    ]
  ]
);
console.log(environment);

var correct = [1,2,"Fizz",4,"Buzz","Fizz",7,8,"Fizz","Buzz",11,"Fizz",13,14,"FizzBuzz",16,17,"Fizz",19,"Buzz","Fizz",22,23,"Fizz","Buzz",26,"Fizz",28,29,"FizzBuzz",31,32,"Fizz",34,"Buzz","Fizz",37,38,"Fizz","Buzz",41,"Fizz",43,44,"FizzBuzz",46,47,"Fizz",49,"Buzz","Fizz",52,53,"Fizz","Buzz",56,"Fizz",58,59,"FizzBuzz",61,62,"Fizz",64,"Buzz","Fizz",67,68,"Fizz","Buzz",71,"Fizz",73,74,"FizzBuzz",76,77,"Fizz",79,"Buzz","Fizz",82,83,"Fizz","Buzz",86,"Fizz",88,89,"FizzBuzz",91,92,"Fizz",94,"Buzz","Fizz",97,98,"Fizz","Buzz"];
console.log(_.difference(toTest, correct).length == 0);
</script>
</html>