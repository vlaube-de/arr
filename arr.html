<html>
  <head>
    <title></title>
    <script type="text/javascript" src="underscore.js"></script>
  </head>
  <body></body>
<script>

function cond() {
  var resultClause = _.find(arguments, function(clause) { return clause[0]; });
  return resultClause[1];
}

function eq(a, b) {
  return a === b;
}

function mod(a, b) {
  return a % b;
}

function print(str) {
  document.writeln(str+'<br />');
}

function lambda() {
  var environment = this;
  var argNames = _.initial(arguments);
  var array = _.last(arguments);

  return function() {
    // add arguments to the environment
    // FIXME: only add them to the local environment
    var args = _.object(argNames, arguments);
    _.extend(environment, args);

    return arr(environment, array);
  };
}

function arr(environment, array) {
  if(!array) {
    array = environment;
    environment = {};
  }
  if(array instanceof Array) {
    if(array[0] != lambda && array[0] != defun) { // do not evaluate the body of a lambda expression (yet)
      array = _.map(array, function(value) {
        return arr(environment, value);
      });
    }
  } else if(typeof array == 'string') {
    try {
      // XXX: does this make the variables immutable?
      with(environment) {
        array = eval(array);
      }
    } catch(e) {}
  }

  var first = _.first(array);

  if(typeof first == 'string') {
    if(environment[first]) {
      first = environment[first];
    } else {
      return array;
    }
  }
  if(typeof first == 'function') {
    var rest = _.rest(array);
    return first.apply(environment, rest);
  }
  return array;
}

var each = _.each;
var map = _.map;
var range = _.range;

arr(
 [each,
    [map,
      [range, 1, 101],
      [lambda, 'number',
        [cond,
          [[eq, [mod, 'number', 15], 0], 'FizzBuzz'],
          [[eq, [mod, 'number',  3], 0], 'Fizz'],
          [[eq, [mod, 'number',  5], 0], 'Buzz'],
          [true, 'number']
        ]
      ]
    ],
    print
  ]
);

</script>
</html>